version: 1.0.0.{build}
image:
- Visual Studio 2017
- Ubuntu1804

platform:
  - x86
  - x64

configuration:
  - Release
  - Debug
  - RelWithDebInfo

environment:
  matrix:
    - LINKING: static
    - LINKING: shared

matrix:
  exclude:
    - image: Ubuntu1804
      platform: x86
    - image: Ubuntu1804
      LINKING: static

for:
-
  matrix:
    only:
      - image: Ubuntu1804

  build_script:
    - mkdir build
    - cd build
    - cmake -DBUILD_TESTING=ON ..
    - cmake --build . --config $CONFIGURATION

  test_script:
    - ctest -C $CONFIGURATION

  after_test:
  - cpack -G ZIP -C $CONFIGURATION
-
  matrix:
    only:
      - image: Visual Studio 2017

  build_script:
    - mkdir build
    - cd build
    - set FLAGS= 
    - if %LINKING%==static (set FLAGS=%FLAGS% -DBUILD_TESTING=ON)
    - if %LINKING%==shared (set FLAGS=%FLAGS% -DBUILD_SHARED_LIBS=ON)
    - if %PLATFORM%==x64 (set FLAGS=%FLAGS% -G "Visual Studio 15 2017 Win64")
    - cmake %FLAGS% ..
    - cmake --build . --config %CONFIGURATION%
  
  test_script:
    - if %LINKING%==static (ctest -C %CONFIGURATION%)

  after_test:
  - cpack -G ZIP -C %CONFIGURATION%


artifacts:
  - path: 'build/libriffcpp-*.zip'

deploy:
  - provider: GitHub
    auth_token:
      secure: PKQ8wyiF5mNTAWbKepUrcnec7bucnXJ/T+Ip1NfxblviD6BqamxMuSQI1Kk5mCm+
    artifact: /.*/
    draft: true
    prerelease: false
    on:
      branch: master
      APPVEYOR_REPO_TAG: true